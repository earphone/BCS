<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <meta name="description" content=""> 
        <meta name="author" content=""> 
        <title>BCS Webapp Dashboard</title>
        <!-- Bootstrap Core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> 
        <!-- MetisMenu CSS -->
        <link href="vendor/metisMenu/metisMenu.min.css" rel="stylesheet"> 
        <!-- Custom CSS -->
        <link href="dist/css/sb-admin-2.css" rel="stylesheet"> 
        <!-- Morris Charts CSS -->
        <link href="vendor/morrisjs/morris.css" rel="stylesheet"> 
        <!-- Custom Fonts -->
        <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"> 
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->         
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->         
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    </head>
    <body onload="checkUser()"> 
        <div id="wrapper"> 
            <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0"> 
                <div class="navbar-header"> 
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> 
                        <span class="sr-only">Toggle navigation</span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                    </button>                     
                    <a class="navbar-brand" href="index.html"><b>BCS Webapp</b></a> 
                </div>                 
                <div class="navbar-default sidebar" role="navigation"> 
                    <div class="sidebar-nav navbar-collapse"> 
                        <ul class="nav" id="side-menu"> 
                            <li> 
                                <a href="pages/index.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a> 
                            </li>                             
                            <li> 
                                <a href="pages/dpr.html"><i class="fa fa-list-alt fa-fw"></i> DPR</a> 
                            </li>                             
                            <li> 
                                <a href="pages/dtr.html"><i class="fa fa-list fa-fw"></i> DTR</a> 
                            </li>                             
                            <li> 
                                <a href="pages/profile.html"><i class="fa fa-user fa-fw"></i>&nbsp;Profile</a> 
                            </li>                             
                            <li> 
                                <a href="pages/admin.html"><i class="fa fa-gamepad fa-fw"></i> Admin</a> 
                            </li>                             
                            <li> 
                                <a href="pages/login.html"><i class="fa fa-sign-out fa-fw"></i> Logout</a> 
                            </li>                             
                        </ul>                         
                    </div>                     
                </div>                 
            </nav>             
            <div id="page-wrapper"> 
                <div class="row"> 
                    <div class="col-lg-12"> 
                        <h1 class="page-header" id="dashboard-header">Dashboard</h1> 
                    </div>                     
                </div>                 
                <div class="row"> 
                    <div class="col-lg-12"> 
                        <div class="panel panel-default"> 
                            <div class="panel-heading"> 
                                <i class="fa fa-rebel fa-fw"></i> Recent Reports
                            </div>                             
                            <div class="panel-body"> 
                                <div class="list-group" id="list-report"> 
                                    <!-- This will be filled in on load with checkUser() -->                                     
                                    <!--div class="list-group-item">
                                        There is no data to be shown... 
                                        <i class="fa fa-meh-o fa-fw"></i>
                                    </div-->                                     
                                </div>                                 
                            </div>                             
                        </div>                         
                        <div class="panel panel-default"> 
</div>                         
                        <div class="chat-panel panel panel-default"> 
                            <div class="panel-footer"> 
                                <div class="form-group" id="report-data"> 
                                    <h4><i class="fa fa-beer fa-fw"></i>Data will be down here<i class="fa fa-database fa-fw"></i></h4> 
                                </div>                                 
                            </div>                             
                        </div>                         
                    </div>                     
                </div>                 
            </div>             
        </div>         
        <!-- Firebase Keys -->         
        <script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>         
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyA55RJ8kvG-n-UClBQSNjnjLK3dvb1vwd8",
                authDomain: "bcs-webapp.firebaseapp.com",
                databaseURL: "https://bcs-webapp.firebaseio.com",
                storageBucket: "bcs-webapp.appspot.com",
                messagingSenderId: "664106049370"
            };
            firebase.initializeApp(config);
        </script>         
        <script>
        	function checkUser() {
                console.log("Checking User!");
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        console.log(user.uid + " is signed in");
                        var initials;
                        var userRef = firebase.database().ref("/employees/employed/" + user.uid);
                        var dprRef = firebase.database().ref("/employees/employed/" + user.uid + "/history/dpr");
                        var dtrRef = firebase.database().ref("/employees/employed/" + user.uid + "/history/dpr");
                        userRef.once("value", function(snapshot) {
                            console.log("User email: " + user.email + " Snapshot: " + snapshot.val().email);
                            //console.log(user);
                            initials = snapshot.val().initials;
                            window.document.getElementById('dashboard-header').innerText = "Hello " + user.displayName;
                            // User is signed in.
                        	// Get data for user's last 14 reports (7 DPR and 7 DTR) and place them in the panel with links to open below
                            console.log("Ordering by key");
                            var listDiv = document.getElementById("list-report");
                            dprRef.orderByKey().limitToLast(8).on("child_added", function(snapshot) {
                                //console.log(snapshot.key);
                                var randomId;
                                var dprElement = document.createElement("a");
                                var date = snapshot.key;
                                var jobNum;
                                snapshot.forEach(function(childSnapshot) {
                                    jobNum = childSnapshot.key;
                                    childSnapshot.forEach(function(grandchildSnapshot) {
                                        randomId = grandchildSnapshot.key;
                                    });
                                });
                                date = date.replace("-","").replace("-","");
                                dprElement.href = "javascript:void(0)";
                                dprElement.onclick = function showData() {
                                    //console.log("Boop: " + randomId);
                                    var dataDiv = document.getElementById("report-data");
                                    // Clear previous data
                                    dataDiv.innerHTML = "";
                                    // Load data for this specific randomId
                                    firebase.database().ref('dpr/randomId/' + randomId).once('value').then(function(snapshot) {
                                      // ...
                                        var headerElement = document.createElement("h3");
                                        var contractorElement = document.createElement("h4");
                                        var techsLabelElement = document.createElement("h4");
                                        var iqrLabelElement = document.createElement("h4");
                                        var iqrElement = document.createElement("h5");
                                        var neededLabelElement = document.createElement("h4");
                                        var neededElement = document.createElement("h5");
                                        var performedLabelElement = document.createElement("h4");
                                        var progressLabelElement = document.createElement("h4");
                                		var dataElement = document.createElement("a");
                                        // Header data (needs buttons for edit/delete)
                                        headerElement.textContent = "DPR for Job #" + snapshot.val().jobNum + " on " + snapshot.val().date + " from " + snapshot.val().timeStart + " to " + snapshot.val().timeEnd;
                                        dataDiv.append(headerElement);
                                        dataDiv.append(document.createElement("hr"));
                                        // Contractor Data
                                        contractorElement.textContent = "CONTRACTOR: " + snapshot.val().contractor;
                                        dataDiv.append(contractorElement);
                                        // Display data for each tech
                                        firebase.database().ref("dpr/randomId/" + randomId + "/techs").orderByKey().once("value", function(childSnapshot) {
                                            techsLabelElement.textContent = "TECHNICIANS:";
                                            dataDiv.append(techsLabelElement);
                                            var num = 0;
                                            childSnapshot.forEach(function(grandChildSnapshot) {
                                                var techElement = document.createElement("h5");
                                                num ++;
                                                if(grandChildSnapshot.val().journeyman) techElement.textContent = grandChildSnapshot.val().name + " the Journeyman worked " + grandChildSnapshot.val().hours + " hours";
                                                else if(grandChildSnapshot.val().apprentice) techElement.textContent = grandChildSnapshot.val().name + " the Apprentice Step " + grandChildSnapshot.val().step + " worked " + grandChildSnapshot.val().hours + " hours";
                                                else techElement.textContent = grandChildSnapshot.val().name + " worked " + grandChildSnapshot.val().hours + " hours";
                                                dataDiv.append(techElement);
                                            });
                                            if(num == 0) {
                                                var techElement = document.createElement("h5");
                                                techElement.textContent = "No techs selected";
                                                dataDiv.append(techElement);
                                            }
                                        });
                                        // Iqr Data
                                        iqrLabelElement.textContent = "INSTALLATION ISSUES/QUESTION/REMARKS:";
                                        dataDiv.append(iqrLabelElement);
                                        iqrElement.textContent = snapshot.val().iqr;
                                        dataDiv.append(iqrElement);
                                        // Materials Needed & By data
                                        neededLabelElement.textContent = "MATERIAL/EQUIPMENT NEEDED:";
                                        dataDiv.append(neededLabelElement);
                                        neededElement.textContent = "By " + snapshot.val().by + " they need: " + snapshot.val().needed;
                                        dataDiv.append(neededElement);
                                        // Work Performed Data
                                        firebase.database().ref("dpr/randomId/" + randomId + "/work").orderByKey().once("value", function(childSnapshot) {
                                            var num = 0;
                                            performedLabelElement.textContent = "WORK PERFORMED:";
                                            dataDiv.append(performedLabelElement);
                                            childSnapshot.forEach(function(grandChildSnapshot) {
                                                num ++;
                                                var performedElement = document.createElement("h5");
                                                if((num == 1) && (grandChildSnapshot.val().location == "") && (grandChildSnapshot.val().done == "")) {
                                                    performedElement.textContent = "No work reported...";
                                                }
                                                else performedElement.textContent = "Work Performed at: " + grandChildSnapshot.val().location + ": " + grandChildSnapshot.val().done;
                                                dataDiv.append(performedElement);
                                            });
                                        });
                                        // Work Progress Data
                                        firebase.database().ref("dpr/randomId/" + randomId + "/work").orderByKey().once("value", function(childSnapshot) {
                                            var num = 0;
                                            var progressExampleElement = document.createElement("h5");
                                            progressLabelElement.textContent = "PROGRESS TRACKING (in the following format):";
                                            dataDiv.append(progressLabelElement);
                                            progressExampleElement.textContext = "LOCATION - TR BUILD OUT - PATHWAYS - ROUGH IN - TERMINATIONS - TESTING";
                                            dataDiv.append(
                                            childSnapshot.forEach(function(grandChildSnapshot) {
                                                num ++;
                                                var progressElement = document.createElement("h5");
                                                if((num == 1) && (grandChildSnapshot.val().location == "")) {
                                                    performedElement.textContent = "No progress reported...";
                                                }
                                                else performedElement.textContent = grandChildSnapshot.val().location + " - " + grandChildSnapshot.val().tr + "% - " + grandChildSnapshot.val().pathway + "% - " + grandChildSnapshot.val().roughIn + "% - " + grandChildSnapshot.val().terminations + "% - " + grandChildSnapshot.val().testing + "%";
                                                dataDiv.append(performedElement);
                                            });
                                        });
                                        // Hidden Data with randomId (needs ID to call when going to next page)
                                        // Random data
                               			dataElement.className = "list-group-item";
                                    	dataElement.text = snapshot.val().date;
                                        dataDiv.append(dataElement);
                                    });
                                }
                                dprElement.className = "list-group-item";
                                dprElement.text = "DPR_" + jobNum + "_" + date + "_" + initials;
                                console.log(randomId);
                                // Onclick will enact the showData() function for the randomId
                                listDiv.insertBefore(dprElement, listDiv.firstChild);
                            });
                            dprRef.orderByKey().off("child_added");
                    	});
                    }
                    else {
                        // No user is signed in.
                        window.location="pages/login.html";
                    }
                });
            }
        </script>         
        <!-- /#wrapper -->         
        <!-- jQuery -->         
        <script src="vendor/jquery/jquery.min.js"></script>         
        <!-- Bootstrap Core JavaScript -->         
        <script src="vendor/bootstrap/js/bootstrap.min.js"></script>         
        <!-- Metis Menu Plugin JavaScript -->         
        <script src="vendor/metisMenu/metisMenu.min.js"></script>         
        <!-- Morris Charts JavaScript -->         
        <script src="vendor/raphael/raphael.min.js"></script>         
        <script src="vendor/morrisjs/morris.min.js"></script>         
        <script src="data/morris-data.js"></script>         
        <!-- Custom Theme JavaScript -->         
        <script src="dist/js/sb-admin-2.js"></script>         
        <script src="js/app.js"></script>         
    </body>     
</html>
