<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <meta name="description" content=""> 
        <meta name="author" content=""> 
        <title>BCS Webapp DPR</title>         
        <!-- Bootstrap Core CSS -->         
        <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> 
        <!-- MetisMenu CSS -->         
        <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet"> 
        <!-- Custom CSS -->         
        <link href="../dist/css/sb-admin-2.css" rel="stylesheet"> 
        <!-- Custom Fonts -->         
        <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"> 
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->         
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->         
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->         
    </head>     
    <body onload="checkUser()"> 
        <div id="wrapper"> 
            <!-- Navigation -->             
            <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0"> 
                <div class="navbar-header"> 
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> 
                        <span class="sr-only">Toggle navigation</span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                    </button>                     
                    <a class="navbar-brand" href="index.html"><b>BCS Webapp</b></a> 
                </div>                 
                <!-- /.navbar-header -->                 
                <!-- /.navbar-top-links -->                 
                <div class="navbar-default sidebar" role="navigation"> 
                    <div class="sidebar-nav navbar-collapse"> 
                        <ul class="nav" id="side-menu"> 
                            <li> 
                                <a href="index.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a> 
                            </li>                             
                            <li> 
                                <a href="dpr.html"><i class="fa fa-list-alt fa-fw"></i> DPR</a> 
                            </li>                             
                            <li> 
                                <a href="dtr.html"><i class="fa fa-list fa-fw"></i> DTR</a> 
                            </li>                             
                            <li> 
                                <a href="profile.html"><i class="fa fa-user fa-fw"></i>&nbsp;Profile</a> 
                            </li>                             
                            <li> 
                                <a href="admin.html"><i class="fa fa-gamepad fa-fw"></i> Admin</a> 
                            </li>                             
                            <!-- fa-institution -->                             
                            <li> 
                                <a href="login.html" onclick="logoutUser()" id="logout"><i class="fa fa-sign-out fa-fw"></i> Logout</a> 
                            </li>                             
                        </ul>                         
                    </div>                     
                    <!-- /.sidebar-collapse -->                     
                </div>                 
                <!-- /.navbar-static-side -->                 
            </nav>             
            <!-- Page Content -->             
            <div id="page-wrapper"> 
                <!-- Div for Page Header -->
                <div class="container-fluid"> 
                    <div class="row"> 
                        <div class="col-lg-12"> 
                            <h1 class="page-header">Daily Progress Report</h1> 
                        </div>                         
                    </div>                     
                </div>                 
                <!-- Main body Div -->
                <div> 
                    <h3><i class="fa fa-edit fa-fw"></i>Please Fill out the Information Below for a DPR!</h3> 
                    <div class="form-group"> 
                        <label class="control-label">JOB NUMBER</label>                         
                        <input class="form-control" placeholder="xx-xxx" name="job-num" type="text" value="" id="job-num"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">JOB NAME</label>                         
                        <input class="form-control" placeholder="Job Name" name="job-name" type="text" value="" id="job-name"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">DATE</label>                         
                        <br> 
                        <input class="form-control" type="date" name="dpr-date" id="dpr-date" min="2016-01-01"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">CONTRACTOR</label>                         
                        <input class="form-control" placeholder="Contractor" name="contractor" type="text" value="" id="contractor"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">START TIME</label>                         
                        <input class="form-control" name="time-start" type="time" value="07:30" id="time-start" placeholder="0000"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">END TIME</label>                         
                        <input class="form-control" name="time-end" type="time" value="15:30" id="time-end" placeholder="2400"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">FOREMAN</label>                         
                        <input class="form-control" name="foreman" type="text" value="" id="foreman" placeholder="First Last"> 
                    </div>                     
                    <div class="form-group"> 
                        <label class="control-label">TECHNICIANS</label>                         
                        <select class="form-control" name="techs" type="select" multiple value="" id="techs" placeholder="First Last" onclick="techHours(value)"></select>
                    </div>                     
                    <div>
                        <label class="control-label">HOURS WORKED</label>
                        <div class="form-group" id="tech-hours">
</div>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-sm btn-info" id="work-more" onclick="techHours()">Set Hours for Chosen Techs?</button>
                    </div>
                    <div class="form-group"> 
                        <label class="control-label">INSTALLATION ISSUES / QUESTIONS / REMARKS</label>
                        <input class="form-control" placeholder="ANY ISSUES SHOULD BE REPORTED IMMEDIATELY BY PHONE ALSO" name="iqr" type="text" value="" id="iqr"> 
                    </div>                     
                    <div class="row"> 
                        <div class="form-group col-xs-8"> 
                            <label class="control-label">MATERIAL / EQUIPMENT NEEDED</label>                             
                            <input class="form-control" placeholder="Notify PM ASAP" name="materials-needed" type="text" value="" id="materials-needed"> 
                        </div>                         
                        <div class="form-group col-xs-4"> 
                            <label class="control-label">NEEDED BY</label>                             
                            <input class="form-control" type="date" name="materials-by" id="materials-by" min="2016-01-01"> 
                        </div>                         
                    </div>                     
                    <div id="work">
                        <div class="row">
                            <div class="form-group col-xs-8"> 
                                <label class="control-label">WORK PERFORMED</label>                                 
                                <input class="form-control" placeholder="Work Done" name="work-done" type="text" value="" id="work-done"> 
                            </div>                             
                            <div class="form-group col-xs-4"> 
                                <label class="control-label">LOCATION</label>                                 
                                <input class="form-control" type="text" placeholder="ID # / Floor" name="work-location" id="work-location"> 
                            </div>                             
                        </div>
                    </div>                     
                    <div class="form-group"> 
                        <button type="button" class="btn btn-sm btn-info" id="work-more" onclick="workMore()">More Work Done?</button>                         
                    </div>                     
                    <label class="control-label"> 
                        <u>PROGRESS (% COMPLETED) Ex. 75</u> 
                    </label>                     
                    <div id="progress"> 
                        <div class="row">
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">LOCATION</label>                                 
                                <input class="form-control" placeholder="Location" name="location" type="text" value="" id="location"> 
                            </div>                             
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">TR</label>                                 
                                <input class="form-control" placeholder="TR" name="tr" type="number" value="" id="tr"> 
                            </div>                             
                        </div>
                        <div class="row">
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">PATHWAY</label>                                 
                                <input class="form-control" placeholder="Pathway" name="pathway" type="number" value="" id="pathway"> 
                            </div>                             
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">ROUGH IN</label>                                 
                                <input class="form-control" placeholder="Rough In" name="rough-in" type="number" value="" id="rough-in"> 
                            </div>                             
                        </div>
                        <div class="row">
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">TERMINATIONS</label>                                 
                                <input class="form-control" placeholder="Terminations" name="terminations" type="number" value="" id="terminations"> 
                            </div>                             
                            <div class="form-group col-xs-6"> 
                                <label class="control-label">TESTING</label>                                 
                                <input class="form-control" placeholder="Testing" name="testing" type="number" value="" id="testing"> 
                            </div>                             
                        </div>
                    </div>                     
                    <div class="form-group"> 
                        <button type="button" class="btn btn-sm btn-info" id="progress-more" onclick="progressMore()">More Location Progress?</button>                         
                    </div>                     
                    <p><button type="button" class="btn btn-lg btn-success" id="update-button" onclick="updateData()">Submit!</button></p> 
                </div>                 
            </div>             
        </div>         
        <!-- Firebase Initialization -->         
        <script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>         
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyA55RJ8kvG-n-UClBQSNjnjLK3dvb1vwd8",
                authDomain: "bcs-webapp.firebaseapp.com",
                databaseURL: "https://bcs-webapp.firebaseio.com",
                storageBucket: "bcs-webapp.appspot.com",
                messagingSenderId: "664106049370"
            };
            firebase.initializeApp(config);
        </script>         
        <!-- Firebase Create User -->         
        <script>
        function logoutUser() {
            firebase.auth().signOut().then(function() {
              console.log('Signed Out');
            }, function(error) {
              console.error('Sign Out Error', error);
            });
        }
        </script>         
        <!-- Checks if user is logged in. If not,  redirects to Login page -->         
        <script>
        function checkUser() {
            console.log("Checking User!");
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    console.log(user.uid + " is signed in");
                    // User is signed in.
                    // Display the name of the person submitting this form as the foreman
                    document.getElementById("foreman").value = user.displayName;
                    // Fill in Technicians list of all techs
                    var techList = document.getElementById("techs");
                    var query = firebase.database().ref("employees/technicians/").orderByKey();
                    query.once("value")
                    	.then(function(snapshot) {
                        	snapshot.forEach(function(childSnapshot) {
                                var option = document.createElement("option");
                                option.text = childSnapshot.val().name;
                                techList.add(option);
                        	});
                    	});
                } else {
                    // No user is signed in.
                    window.location="login.html";
                }
            });
        }
        </script>         
        <script>
        function techHours() {
            var techs = document.getElementById("techs").options;
            var hoursDiv = document.getElementById("tech-hours");
            hoursDiv.innerHTML = "";
            for(i=0; i<techs.length;i++) {
                        if(techs[i].selected) {
                            hoursDiv.innerHTML += <input class="form-control" type="number">;
                        }
                    }
        }
        </script>
        <script>
        function updateData() {
            var jobNum = document.getElementById("job-num").value;
            var jobName = document.getElementById("job-name").value;
            var date = document.getElementById("dpr-date").value;
            var contractor = document.getElementById("contractor").value;
            var timeStart = document.getElementById("time-start").value;
            var timeEnd = document.getElementById("time-end").value;
            var foreman = document.getElementById("foreman").value;
            var techs = document.getElementById("techs").options;
            var techList = [];
            var iqr = document.getElementById("iqr").value;
            var materialsNeeded = document.getElementById("materials-needed").value;
            var materialsBy = document.getElementById("materials-by").value;
            var user = firebase.auth().currentUser;
            console.log("tech length: " + techs.length);
            var newDPR = firebase.database().ref('dpr').child("randomId").push();
            console.log("newDPR: " + newDPR);
            var newDPRKey = newDPR.key;
            var userInitials;
            var query = firebase.database().ref("employees/technicians/").orderByKey();
            var techClass;
            var techAdded = 0;
            firebase.database().ref("employees/employed/" + user.uid + "/initials/").once('value').then(function(snapshot) {
            	userInitials = snapshot.val();
                console.log("User Initials: " + userInitials);
        	});
            query.once("value").then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var name = childSnapshot.val().name;
                    console.log(childSnapshot.val());
                    for(i=0; i<techs.length;i++) {
                        if(techs[i].selected) {
							if(techs[i].value == name) {
                                if(childSnapshot.val().journeyman) {
                                    techClass = "Journeyman";
                                }
                                else {
                                    techClass = "Apprentice Step " + childSnapshot.val().step;
                                }
                                techList.push(childSnapshot.val());
                                techAdded++;
                            }
                        }
                    }
                });
                // Set data for short DPR by Job #
                firebase.database().ref('dpr/jobNum/' + jobNum + "/" + date).set({
                    submittedBy: user.displayName,
                    userID: user.uid,
                    randomID: newDPRKey
                });
                // Set data for short DPR by Date
                firebase.database().ref('dpr/date/' + date + "/" + jobNum).set({
                    submittedBy: user.displayName,
                    userID: user.uid,
                    randomID: newDPRKey
                });
                // Set data for long DPR
                newDPR.set({
                    submittedBy: user.displayName,
                    submittedInitials: userInitials,
                    jobNum: jobNum,
                    jobName: jobName,
                    date: date,
                    contractor: contractor,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    foreman: foreman,
                    techs: techList,
                    iqr: iqr,
                    needed: materialsNeeded,
                    by: materialsBy
                })
                .then(function() {
                    // If set correctly
                    alert("Data Updated Successfully!");
                    location.reload();
                })
                .catch(function(error) {
                    alert("Something Happened when setting details: " + error.message);
                })
            });
        }            
        </script>         
        <script>
        function workMore() {
            var inputWork = document.createElement("input");
            var inputLocation = document.createElement("input");
            var newDiv = document.createElement("div");
            var workDiv = document.createElement("div");
            var locationDiv = document.createElement("div");
            inputWork.type = "text";
            inputWork.className = "form-control col-xs-8";
            inputWork.placeholder = "Work Done";
            inputLocation.type = "text";
            inputLocation.className = "form-control col-xs-4";
            inputLocation.placeholder = "Location";
            workDiv.className = "form-group col-xs-8";
            locationDiv.className = "form-group col-xs-4";
            newDiv.className = "row";
            workDiv.appendChild(inputWork);
            locationDiv.appendChild(inputLocation);
            newDiv.appendChild(workDiv);
            newDiv.appendChild(locationDiv);
            document.getElementById("work").appendChild(newDiv);
        }
        </script>         
        <script>
        function progressMore() {
            var progressLocation = document.createElement("input");
            var progressTR = document.createElement("input");
            var progressPathway = document.createElement("input");
            var progressRoughIn = document.createElement("input");
            var progressTerminations = document.createElement("input");
            var progressTesting = document.createElement("input");
            var newDiv = document.createElement("div");
            var topDiv = document.createElement("div");
            var midDiv = document.createElement("div");
            var bottomDiv = document.createElement("div");
            var locationDiv = document.createElement("div");
            var trDiv = document.createElement("div");
            var pathwayDiv = document.createElement("div");
            var roughInDiv = document.createElement("div");
            var terminationsDiv = document.createElement("div");
            var testingDiv = document.createElement("div");
            var newLabel = document.createElement("label");
            var newLabelText = document.createTextNode("New Location Progress");
            newLabel.className = "control-label";
            newLabel.type = "text";
            newLabel.appendChild(newLabelText);
            progressLocation.type = "text";
            progressLocation.className = "form-control col-xs-6";
            progressLocation.placeholder = "Location";
            progressTR.type = "number";
            progressTR.className = "form-control col-xs-6";
            progressTR.placeholder = "TR";
            progressPathway.type = "number";
            progressPathway.className = "form-control col-xs-6";
            progressPathway.placeholder = "Pathway";
            progressRoughIn.type = "number";
            progressRoughIn.className = "form-control col-xs-6";
            progressRoughIn.placeholder = "Rough In";
            progressTerminations.type = "number";
            progressTerminations.className = "form-control col-xs-6";
            progressTerminations.placeholder = "Terminations";
            progressTesting.type = "number";
            progressTesting.className = "form-control col-xs-6";
            progressTesting.placeholder = "Testing";
            locationDiv.className = "form-group col-xs-6";
            trDiv.className = "form-group col-xs-6";
            pathwayDiv.className = "form-group col-xs-6";
            roughInDiv.className = "form-group col-xs-6";
            terminationsDiv.className = "form-group col-xs-6";
            testingDiv.className = "form-group col-xs-6";
            topDiv.className = "row";
            midDiv.className = "row";
            bottomDiv.className = "row";
            locationDiv.appendChild(progressLocation);
            trDiv.appendChild(progressTR);
            pathwayDiv.appendChild(progressPathway);
            roughInDiv.appendChild(progressRoughIn);
            terminationsDiv.appendChild(progressTerminations);
            testingDiv.appendChild(progressTesting);
            topDiv.appendChild(locationDiv);
            topDiv.appendChild(trDiv);
            midDiv.appendChild(pathwayDiv);
            midDiv.appendChild(roughInDiv);
            bottomDiv.appendChild(terminationsDiv);
            bottomDiv.appendChild(testingDiv);
            newDiv.appendChild(newLabel);
            newDiv.appendChild(topDiv);
            newDiv.appendChild(midDiv);
            newDiv.appendChild(bottomDiv);
            document.getElementById("progress").appendChild(newDiv);
        }
        </script>         
        <!-- jQuery -->         
        <script src="../vendor/jquery/jquery.min.js"></script>         
        <!-- Bootstrap Core JavaScript -->         
        <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>         
        <!-- Metis Menu Plugin JavaScript -->         
        <script src="../vendor/metisMenu/metisMenu.min.js"></script>         
        <!-- Custom Theme JavaScript -->         
        <script src="../dist/js/sb-admin-2.js"></script>         
    </body>
