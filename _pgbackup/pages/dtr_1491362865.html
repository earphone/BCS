<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <meta name="description" content=""> 
        <meta name="author" content=""> 
        <title>BCS Webapp DTR</title>         
        <!-- Bootstrap Core CSS -->         
        <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> 
        <!-- MetisMenu CSS -->         
        <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet"> 
        <!-- Custom CSS -->         
        <link href="../dist/css/sb-admin-2.css" rel="stylesheet"> 
        <!-- Custom Fonts -->         
        <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"> 
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->         
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->         
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->         
    </head>     
    <body onload="checkUser()"> 
        <div id="wrapper"> 
            <!-- Navigation -->             
            <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0"> 
                <div class="navbar-header"> 
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> 
                        <span class="sr-only">Toggle navigation</span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                        <span class="icon-bar"></span> 
                    </button>                     
                    <a class="navbar-brand" href="index.html"><b>BCS Webapp</b></a> 
                </div>                 
                <!-- /.navbar-header -->                 
                <!-- /.navbar-top-links -->                 
                <div class="navbar-default sidebar" role="navigation"> 
                    <div class="sidebar-nav navbar-collapse"> 
                        <ul class="nav" id="side-menu"> 
                            <li> 
                                <a href="index.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a> 
                            </li>                             
                            <li> 
                                <a href="dpr.html"><i class="fa fa-list-alt fa-fw"></i> DPR</a> 
                            </li>                             
                            <li> 
                                <a href="dpr.html"><i class="fa fa-list fa-fw"></i> DTR</a> 
                            </li>                             
                            <li> 
                                <a href="profile.html"><i class="fa fa-user fa-fw"></i>&nbsp;Profile</a> 
                            </li>                             
                            <li> 
                                <a href="admin.html"><i class="fa fa-gamepad fa-fw"></i> Admin</a> 
                            </li>                             
                            <!-- fa-institution -->                             
                            <li> 
                                <a href="login.html" onclick="logoutUser()" id="logout"><i class="fa fa-sign-out fa-fw"></i> Logout</a> 
                            </li>                             
                        </ul>                         
                    </div>                     
                    <!-- /.sidebar-collapse -->                     
                </div>                 
                <!-- /.navbar-static-side -->                 
            </nav>             
            <!-- Page Content -->             
            <div id="page-wrapper"> 
                <!-- Div for Page Header -->                 
                <div class="container-fluid"> 
                    <div class="row"> 
                        <div class="col-lg-12"> 
                            <h1 class="page-header">Daily Technician Report</h1> 
                        </div>                         
                    </div>                     
                </div>                 
                <!-- Main body Div -->                 
                <div> 
                    <h3><i class="fa fa-edit fa-fw"></i>Please Fill out the Information Below for a DTR!</h3> 
                    <form id="dpr-form"> 
                        <div class="form-group"> 
                            <label class="control-label">JOB NUMBER</label>                             
                            <input class="form-control" placeholder="xx-xxx" name="job-num" type="text" value="" id="job-num" required="true"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">JOB NAME</label>                             
                            <input class="form-control" placeholder="Job Name" name="job-name" type="text" value="" id="job-name"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">DATE</label>                             
                            <br> 
                            <input class="form-control" type="date" name="dpr-date" id="dpr-date" min="2016-01-01" required="true"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">START TIME</label>                             
                            <input class="form-control" name="time-start" type="time" value="07:30" id="time-start" placeholder="0000"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">END TIME</label>                             
                            <input class="form-control" name="time-end" type="time" value="15:30" id="time-end" placeholder="2400"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">TOTAL HOURS</label>                             
                            <input class="form-control" name="time-total" type="number" id="time-total" placeholder="8"> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">REPORT TYPE</label>                             
                            <div class="row form-group"> 
                                <button type="button" class="btn btn-sm btn-info col-xs-3 col-xs-offset-2" id="work-isp" onclick="workISP()">ISP</button>                                 
                                <button type="button" class="btn btn-sm btn-info col-xs-3 col-xs-offset-2" id="work-osp" onclick="workOSP()">OSP</button>                                 
                            </div>                             
                        </div>                         
                        <div class="form-group" id="work-div"> 
                            <hr> 
                            <div class="row"> 
                                <div class="form-group col-xs-6"> 
                                    <h5>WORK PERFORMED</h5> 
                                </div>                                 
                                <div class="form-group col-xs-6"> 
                                    <h5>COST CODE</h5> 
                                </div>                                 
                            </div>                             
                            <div class="row"> 
                                <div class="form-group col-xs-4"> 
                                    <h5>HOURS</h5> 
                                </div>                                 
                                <div class="form-group col-xs-4"> 
                                    <h5>MATERIALS ISSUED</h5> 
                                </div>                                 
                                <div class="form-group col-xs-4"> 
                                    <h5>MATERIALS INSTALLED</h5> 
                                </div>                                 
                            </div>                             
                            <hr> 
                        </div>                         
                        <div class="form-group"> 
                            <label class="control-label">INSTALLATION ISSUES / QUESTIONS / REMARKS</label>                             
                            <input class="form-control" placeholder="ANY ISSUES SHOULD BE REPORTED IMMEDIATELY BY PHONE ALSO" name="iqr" type="text" value="" id="iqr"> 
                        </div>                         
                        <p><button type="button" class="btn btn-lg btn-success" id="update-button" onclick="updateData()">Submit!</button></p> 
                    </form>                     
                </div>                 
            </div>             
        </div>         
        <!-- Firebase Initialization -->         
        <script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>         
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyA55RJ8kvG-n-UClBQSNjnjLK3dvb1vwd8",
                authDomain: "bcs-webapp.firebaseapp.com",
                databaseURL: "https://bcs-webapp.firebaseio.com",
                storageBucket: "bcs-webapp.appspot.com",
                messagingSenderId: "664106049370"
            };
            firebase.initializeApp(config);
        </script>         
        <script>
        // Script that logs out the user when logout button is clicked
        function logoutUser() {
            firebase.auth().signOut().then(function() {
              //console.log('Signed Out');
            }, function(error) {
              //console.error('Sign Out Error', error);
            });
        }
        </script>         
        <script>
        // Script that checks if user is logged in. If not,  redirects to Login page.
        function checkUser() {
            //console.log("Checking User!");
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    //console.log(user.uid + " is signed in");
                    // User is signed in.
                    // Input today's date
                    todaysDate();
                    setInitials();
                } else {
                    // No user is signed in.
                    window.location="login.html";
                }
            });
        }
        </script>         
        <script>
        // Script to submit all updated data to firebase database
        function updateData() {
            var jobNum = document.getElementById("job-num").value;
            var jobName = document.getElementById("job-name").value;
            var date = document.getElementById("dpr-date").value;
            var timeStart = document.getElementById("time-start").value;
            var timeEnd = document.getElementById("time-end").value;
            var timeTotal = document.getElementById("time-total").value;
            var hoursList = [];
            var issuedList = [];
            var installedList = [];
            var iqr = document.getElementById("iqr").value;
            var user = firebase.auth().currentUser;
            var newDTR = firebase.database().ref('dtr').child("randomId").push();
            var newDTRKey = newDTR.key;
            var userInitials = document.getElementById("hidden-initials").value;
            var submit = false;
            var type = null;
            var stop = 0;
            // Get OSP or ISP type
            var test = document.getElementById("work-performed-18");
            console.log(test.textContent);
            if(test == null) type = null;
            else if(test.textContent == "TROUBLESHOOTING") {
                type = "OSP";
                stop = 22;
            }
            else if(test.textContent == "RISER CABLE ROUGH IN") {
                type = "ISP";
                stop = 38;
            }
            console.log("A " + test.textContent == "TROUBLESHOOTING");
            console.log("B " + test.textContent == "RISER CABLE ROUGH IN");
            if((jobNum != null) && (jobNum != "") && (date != null) && (date != "") && (type != null)) submit = true;
            if(submit) {
                // Set data for short DTR by Job #
                firebase.database().ref('dtr/jobNum/' + jobNum + "/" + date + "/" + newDTRKey).set({
                    submittedBy: user.displayName,
                    userID: user.uid,
                    randomID: newDTRKey,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    timeTotal: timeTotal
                });
                // Set data for short DTR by Date
                firebase.database().ref('dtr/date/' + date + "/" + jobNum + "/" + newDTRKey).set({
                    submittedBy: user.displayName,
                    userID: user.uid,
                    randomID: newDTRKey,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    timeTotal: timeTotal
                });
                // Set data for short DTR by Date in user's history path
                firebase.database().ref('employees/employed/' + user.uid + "/history/dtr/" + date + "/" + jobNum + "/" + newDTRKey).set({
                    randomID: newDTRKey
                });
                // Set data for hours, materials issued, and materials installed
                var tempHours;
                var tempIssued;
                var tempInstalled;
                for(var i = 0; i < stop; i++) {
                    console.log(i);
                    tempHours = document.getElementById("hours-" + i);
                    console.log("Searching for issued");
                    tempIssued = document.getElementById("matIssued-" + i);
                    console.log("Searching for installed");
                    tempInstalled = document.getElementById("matInstalled-" + i);
                    if(tempHours != null) {
                        if(tempHours.value != null) hoursList[i] = tempHours.value;
                        if(tempIssued.value != null) issuedList[i] = tempIssued.value;
                        if(tempInstalled.value != null) installedList[i] = tempInstalled.value;
                	}	
                }
                // Set data for long DTR
                newDTR.set({
                    submittedBy: user.displayName,
                    submittedInitials: userInitials,
                    submittedDate: getTodaysDate(),
                    jobNum: jobNum,
                    jobName: jobName,
                    date: date,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    timeTotal: timeTotal,
                    type: type,
                    iqr: iqr,
                    hours: hoursList,
                    matIssued: issuedList,
                    matinstalled: installedList
                })
                    .then(function() {
                    // If set correctly
                    alert("Data Uploaded Successfully!");
                    submit = false;
                    location.reload();
                })
                    .catch(function(error) {
                    alert("Something Happened when setting details: " + error.message);
                    submit = false;
                });
            }
            else {
                if((jobNum == null) || (jobNum =="")) alert("Please input a Job Number");
                else if((date == null) || (date =="")) alert("Please input a Date");
                else if(type == null) alert("Please select ISP or OSP");
            }
        }            
        </script>         
        <script>
        // Script to apply all needed information for ISP
        function workISP() {
            // Show button as selected
            document.getElementById("work-isp").className = "btn btn-sm btn-primary col-xs-3 col-xs-offset-2";
            document.getElementById("work-osp").className = "btn btn-sm btn-info col-xs-3 col-xs-offset-2";
            // Clear main div in document
            var workDiv = document.getElementById("work-div");
            workDiv.innerHTML="";
            var fieldsList = [
            	["PATHWAYS AND SPACES:",""],["INSTALL CEILING HANGER","3-001"],["INSTALL J-HOOK","3-001"],
                ["INSTALL SLEEVE (DRYWALL)","3-001"],["INSTALL SLEEVE (CONCRETE)","3-001"],["INSTALL CONDUIT","3-001"],
                ["INSTALL CABLE RUNWAY/TRAY","3-001"],["MDF/IDF WORK:",""],["INSTALL BACKBOARD","4-001"],
                ["INSTALL CABLE RUNWAY/TRAY","4-002"],["INSTALL GROUND WIRE","4-002"],["INSTALL RACK/CABINET","4-003"],
                ["IDF EQUIPMENT MOUNTING","4-003"],["INSTALL GROUND WIRE","4-003"],["IDF HORIZ CABLE DRESSING","4-004"],
                ["IDF HORIZ CABLE TERMINATIONS","4-004"],["IDF LABELING","4-005"],["RISERS:",""],
                ["RISER CABLE ROUGH IN","5-001"],["RISER CABLE DRESSING","5-001"],["RISER CABLE TERMINATIONS","4-004"],
                ["HORIZONTAL WORK:",""],["IDF TESTING","4-005"],["INSTALL PULL STRING","6-X0X/7-00X"],
                ["CABLE ROUGH-IN","6-X0X/7-00X"],["FISH WALL","6-X0X/7-00X"],["INSTALL MPLS","6-X0X/7-00X"],
                ["INSTALL WIREMOLD","6-X0X/7-00X"],["TERMINATE JACKS","6-X0X/7-00X"],["INSTALL FACEPLATES","6-X0X/7-00X"],
                ["TESTING","6-X0X/7-00X"],["INDIRECT LABOR COSTS:",""],["PUNCHLIST","8-006"],
                ["TROUBLESHOOTING","8-006"],["MATERIAL HANDLING","8-007"],["DEMO:",""],
                ["ISP DEMO","11-001"],["RISER DEMO","11-003"]
            ];
            // For statement runs through all rows
            for(var i = 0; i<38; i++) {
                //console.log("i value: " + i);
                // Divs needed
                var workRowTop = document.createElement("div");
                var workRowBottom = document.createElement("div");
                var workPerformed = document.createElement("div");
                var workCode = document.createElement("div");
                workRowTop.className="row";
                workRowBottom.className="row";
                // Labels needed
                var labelA = document.createElement("label");
                var labelAText = document.createTextNode("word");
                labelAText.nodeValue = fieldsList[i][0];
                labelA.id = ("work-performed-" + i);
                // Switch statement (default sets a number to the input)
                switch(i) {
                    case 0:
                    case 7:
                    case 17:
                    case 21:
                    case 31:
                    case 35:
                        // Set class for div needed
                        workPerformed.className="form-group col-xs-12";
                        // Set data for labels needed
                        labelA.className = "control-label col-xs-12".type = "text";
                        labelA.appendChild(labelAText);
                        // Append children
                        workPerformed.appendChild(labelA);
            			workRowTop.appendChild(workPerformed);
            			workDiv.appendChild(workRowTop);
                        break;
                    default:
                        // Set classes for divs needed
                        workPerformed.className="col-xs-6";
                        workCode.className="col-xs-6";
                        var hoursDiv = document.createElement("div");
                        hoursDiv.className = "form-group col-xs-4";
                        var issuedDiv = document.createElement("div");
                        issuedDiv.className = "form-group col-xs-4";
                        var installedDiv = document.createElement("div");
                        installedDiv.className = "form-group col-xs-4";
                        // Set data for labels needed
                        labelA.className = "control-label".type = "text";
                        var labelB = document.createElement("label");
                        labelB.className = "control-label".type = "text";
                        var labelBText = document.createTextNode("word");
                        labelA.appendChild(labelAText);
            			labelBText.nodeValue = fieldsList[i][1];
                        labelB.id = ("work-code-" + i);
                        labelB.appendChild(labelBText);
                        // Create inputs for hours, materials issued and installed
                        var inputHours = document.createElement("input");
                        var inputIssued = document.createElement("input");
                        var inputInstalled = document.createElement("input");
                        inputHours.type = "number";
                        inputHours.className = "form-control col-xs-4";
                        inputHours.placeholder = "Hours";
                        inputHours.id = ("hours-" + i);
                        inputIssued.type = "text";
                        inputIssued.className = "form-control col-xs-4";
                        inputIssued.placeholder = "Issued Materials";
                        inputIssued.id = ("matIssued-" + i);
                        inputInstalled.type = "text";
                        inputInstalled.className = "form-control col-xs-4";
                        inputInstalled.placeholder = "Installed Materials";
                        inputInstalled.id = ("matInstalled-" + i);
                        // Append all children
                        workPerformed.appendChild(labelA);
                        workCode.appendChild(labelB);
                        workRowTop.appendChild(workPerformed);
            			workRowTop.appendChild(workCode);
                        hoursDiv.appendChild(inputHours);
                        issuedDiv.appendChild(inputIssued);
                        installedDiv.appendChild(inputInstalled);
                        workRowBottom.append(hoursDiv);
                        workRowBottom.append(issuedDiv);
                        workRowBottom.append(installedDiv);
            			workDiv.appendChild(workRowTop);
                        workDiv.appendChild(workRowBottom);
                }
            }
        }
        </script>         
        <script>
        // Script to apply all needed information for OSP
        function workOSP() {
            // Show button as selected
            document.getElementById("work-isp").className = "btn btn-sm btn-info col-xs-3 col-xs-offset-2";
            document.getElementById("work-osp").className = "btn btn-sm btn-primary col-xs-3 col-xs-offset-2";
            // Clear div on page
            var workDiv = document.getElementById("work-div");
            workDiv.innerHTML="";
            var fieldsList = [
            	["OSP (Including Site Work):",""],["MAINTENANCE HOLE SETUP","2-001"],["ROD AND ROPE","2-001"],
                ["INSTALL INNDERDUCT","2-001"],["INSTALL CABLE","2-001"],["MAINTENANCE HOLE/OUTDOOR WORK:",""],
                ["DRESS CABLES","2-002"],["INSTALL DUCT SEAL","2-002"],["INSTALL TERMINATION BAGS","2-002"],
                ["INSTALL LABELING","2-002"],["SPLICING WORK","2-002"],["MOUNT EQUIPMENT","2-002"],
                ["TERMINATIONS","2-002"],["TESTING","2-002"],["MAINTENANCE HOLE GUARD","2-001"],
                ["TRAFFIC CONTROL","2-001"],["INDIRECT LABOR COSTS:",""],["PUNCHLIST","8-006"],
                ["TROUBLESHOOTING","8-006"],["MATERIAL HANDLING","8-007"],["DEMO:",""],["OSP DEMO","11-002"]
            ];
            // For statement runs through all rows
            for(var i = 0; i<22; i++) {
                //console.log("i value: " + i);
                // Divs needed
                var workRowTop = document.createElement("div");
                var workRowBottom = document.createElement("div");
                var workPerformed = document.createElement("div");
                var workCode = document.createElement("div");
                workRowTop.className="row";
                workRowBottom.className="row";
                // Labels needed
                var labelA = document.createElement("label");
                var labelAText = document.createTextNode("word");
                labelAText.nodeValue = fieldsList[i][0];
                labelA.id = ("work-performed-" + i);
                // Switch statement (default sets a number to the input)
                switch(i) {
                    case 0:
                    case 5:
                    case 16:
                    case 20:
                        // Set class for div needed
                        workPerformed.className="form-group col-xs-12";
                        // Set data for labels needed
                        labelA.className = "control-label col-xs-12".type = "text";
                        labelA.appendChild(labelAText);
                        // Append children
                        workPerformed.appendChild(labelA);
            			workRowTop.appendChild(workPerformed);
            			workDiv.appendChild(workRowTop);
                        break;
                    default:
                        // Set classes for divs needed
                        workPerformed.className="col-xs-6";
                        workCode.className="col-xs-6";
                        var hoursDiv = document.createElement("div");
                        hoursDiv.className = "form-group col-xs-4";
                        var issuedDiv = document.createElement("div");
                        issuedDiv.className = "form-group col-xs-4";
                        var installedDiv = document.createElement("div");
                        installedDiv.className = "form-group col-xs-4";
                        // Set data for labels needed
                        labelA.className = "control-label".type = "text";
                        var labelB = document.createElement("label");
                        labelB.className = "control-label".type = "text";
                        var labelBText = document.createTextNode("word");
                        labelA.appendChild(labelAText);
            			labelBText.nodeValue = fieldsList[i][1];
                        labelB.id = ("work-code-" + i);
                        labelB.appendChild(labelBText);
                        // Create inputs for hours, materials issued and installed
                        var inputHours = document.createElement("input");
                        var inputIssued = document.createElement("input");
                        var inputInstalled = document.createElement("input");
                        inputHours.type = "number";
                        inputHours.className = "form-control col-xs-4";
                        inputHours.placeholder = "Hours";
                        inputHours.id = ("hours-" + i);
                        inputIssued.type = "text";
                        inputIssued.className = "form-control col-xs-4";
                        inputIssued.placeholder = "Issued Materials";
                        inputIssued.id = ("matIssued-" + i);
                        inputInstalled.type = "text";
                        inputInstalled.className = "form-control col-xs-4";
                        inputInstalled.placeholder = "Installed Materials";
                        inputInstalled.id = ("matInstalled-" + i);
                        // Append all children
                        workPerformed.appendChild(labelA);
                        workCode.appendChild(labelB);
                        workRowTop.appendChild(workPerformed);
            			workRowTop.appendChild(workCode);
                        hoursDiv.appendChild(inputHours);
                        issuedDiv.appendChild(inputIssued);
                        installedDiv.appendChild(inputInstalled);
                        workRowBottom.append(hoursDiv);
                        workRowBottom.append(issuedDiv);
                        workRowBottom.append(installedDiv);
            			workDiv.appendChild(workRowTop);
                        workDiv.appendChild(workRowBottom);
                }
            }
        }
        </script>         
        <script>
        // Script that sets dpr-date as today's date (yyyy-mm-dd)
        function todaysDate() {
            date =  new Date();
            year = date.getFullYear();
            month = date.getMonth() + 1;
            if(month < 10) {
            	month = "0" + month;   
            }
            day = date.getDate();
            if(day < 10) {
            	day = "0" + day;   
            }
            document.getElementById("dpr-date").value = year + "-" + month + "-" + day;
        }
        </script>         
        <script>
        function getTodaysDate() {
            date =  new Date();
            year = date.getFullYear();
            month = date.getMonth() + 1;
            if(month < 10) {
            	month = "0" + month;   
            }
            day = date.getDate();
            return year + "-" + month + "-" + day;
        }
        </script>
        <script>
        function setInitials() {
            var workDiv = document.getElementById("work-div");
            var initialsElement = document.createElement("input");
            var user = firebase.auth().currentUser;
            initialsElement.type = "hidden";
            initialsElement.id = "hidden-initials";
            // Get initials for user
            firebase.database().ref("employees/employed/" + user.uid + "/initials/").once('value').then(function(snapshot) {
                initialsElement.value = snapshot.val();
                console.log("userInitials: " + initialsElement.value);
            });
            workDiv.append(initialsElement);
        }
        </script>
        <!-- jQuery -->         
        <script src="../vendor/jquery/jquery.min.js"></script>         
        <!-- Bootstrap Core JavaScript -->         
        <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>         
        <!-- Metis Menu Plugin JavaScript -->         
        <script src="../vendor/metisMenu/metisMenu.min.js"></script>         
        <!-- Custom Theme JavaScript -->         
        <script src="../dist/js/sb-admin-2.js"></script>         
    </body>
